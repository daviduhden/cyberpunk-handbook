name: Archive repository (OpenBSD)

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    name: Archive repository in OpenBSD VM

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Archive repository in OpenBSD VM
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: false
          run: |
            set -x

            echo "Running OpenBSD VM on:"
            uname -a

            # Extraer nombre del repositorio
            REPO_NAME=$(basename "$GITHUB_REPOSITORY")

            # Definir rutas de archivo, checksum y firma
            ARCHIVE_DIR="archive"
            ARCHIVE="${ARCHIVE_DIR}/${REPO_NAME}.tar.gz"
            CHECKSUM="${ARCHIVE}.sha256"
            SIGNATURE="${ARCHIVE}.sig"

            # Crear directorio de archivos y eliminar previos
            mkdir -p "$ARCHIVE_DIR"
            rm -f "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"

            # Crear el archivo tar.gz del repositorio completo
            pax -w . | gzip -n -9 > "$ARCHIVE"

            # Generar checksum SHA256 (OpenBSD usa -q para output limpio)
            sha256 -q "$ARCHIVE" > "$CHECKSUM"

            # Crear archivo temporal de clave privada desde secreto
            echo "${{ secrets.SIGNIFY_KEY }}" | base64 -d > archive.sec
            chmod 600 archive.sec

            # Firmar el archivo usando signify
            signify -S -s archive.sec -m "$ARCHIVE"

            # Listar archivos generados
            ls -lah "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"
